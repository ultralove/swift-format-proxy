# Copilot Instructions for swift-format-proxy

## Project Understanding

This project is `swift-format-proxy`, a smart wrapper around Xcode's bundled `swift-format` tool. Based on my analysis of the codebase and README:

### Core Purpose
- **Primary Goal**: Enable VS Code's apple-swift-format extension to work with Xcode's bundled swift-format (via `xcrun`)
- **Bridge Tool**: Connects VS Code ecosystem with macOS native Swift tooling
- **Intelligent Wrapper**: Provides smart defaults and enhanced error handling for swift-format

### Key Technical Details
1. **Platform Specific**: macOS-only tool that requires Xcode Command Line Tools
2. **Swift 6.1**: Uses latest Swift version with swift-tools-version 6.1
3. **Single File**: Simple `main.swift` executable with focused functionality
4. **No Dependencies**: Pure Foundation-based implementation

### Architecture Analysis
The tool follows a clear, simple architecture:

1. **Environment Validation**:
   - Checks for `xcrun` availability at `/usr/bin/xcrun`
   - Validates `swift-format` can be executed via `xcrun`

2. **Intelligent Defaults**:
   - Auto-detects `Sources/` and `Tests/` directories
   - Applies sensible default arguments when none provided
   - Falls back to help when no valid directories found

3. **Pass-through Design**:
   - Maintains full compatibility with underlying swift-format
   - Preserves all I/O streams (stdin, stdout, stderr)
   - Returns proper exit codes for CI/scripting integration

### Use Case Prioritization
1. **Primary**: VS Code extension integration
2. **Secondary**: Command-line usage with smart defaults
3. **Tertiary**: CI/CD integration and pre-commit hooks

### Design Philosophy
- **Zero Configuration**: Works out of the box for standard Swift packages
- **Non-invasive**: Doesn't change swift-format behavior, just enhances it
- **Error Clarity**: Provides clear, actionable error messages
- **Compatibility First**: Maintains 100% compatibility with underlying tool

## Development Guidelines

When working on this project:

1. **Maintain Simplicity**: Keep the single-file architecture
2. **Preserve Compatibility**: Never break swift-format argument compatibility
3. **macOS Focus**: This is intentionally macOS-specific, don't add cross-platform abstractions
4. **VS Code Priority**: Primary use case is VS Code extension support
5. **Error Handling**: Maintain clear, helpful error messages with specific exit codes
6. **Performance**: Keep startup time minimal for responsive editor integration
7. **Documentation**: Update these copilot instructions as we go - whenever significant changes are made to the project structure, workflows, or development processes, update this file to reflect the current state

### Commit Workflow
When asked to "commit the latest changes":
1. Stage all changes with `git add .`
2. Write a detailed but concise commit message using conventional commits format
3. Commit the changes with the generated message
4. Do this automatically without asking for confirmation

## Context for AI Assistance

This tool solves a specific integration problem: VS Code's apple-swift-format extension needs to work with Xcode's bundled swift-format tool, but the extension expects certain behaviors that the raw tool doesn't provide. The proxy adds:

- Automatic project structure detection
- Sensible default arguments
- Enhanced error reporting
- Reliable exit code handling

The tool is intentionally minimal and focused, avoiding feature creep while solving the core integration challenge effectively.

## GitHub Workflows Documentation

This project includes two comprehensive GitHub Actions workflows for automated building and releasing. The workflows are designed to create professional releases with complete documentation and version tracking.

### Build Workflow (`.github/workflows/build.yml`)

**Purpose**: Automated development builds triggered on feature branches and pull requests.

**Triggers**:
- Push to `develop` branch
- Push to any `feature/**` branch
- Pull requests targeting `develop` or `feature/**` branches

**Key Features**:
- **Universal Binary Creation**: Builds for both x86_64 and arm64 architectures using `lipo`
- **Automatic Changelog**: Generates CHANGELOG.md with last 10 commits and links to GitHub
- **Build Metadata**: Creates BUILDINFO.md with complete build details
- **Prerelease Creation**: Automatically creates GitHub prerelease with generated tag
- **Artifact Management**: Uploads both individual binary and complete zip archive

**Release Package Contents**:
- `swift-format-proxy` - Universal macOS binary
- `README.md` - Project documentation
- `LICENSE` - MIT License file
- `CHANGELOG.md` - Recent changes and build information
- `BUILDINFO.md` - Complete build metadata and Bill of Materials

**Critical Steps to Maintain**:
1. **Swift Version**: Currently set to 6.1 - update as needed
2. **Architecture Support**: Builds universal binary (x86_64 + arm64)
3. **Naming Convention**: `swift-format-proxy-build-{BUILD_NUMBER}-{DATE}`
4. **Cache Strategy**: Caches Swift packages for faster builds
5. **Retention Policy**: Binary artifacts 30 days, releases 90 days

### Release Workflow (`.github/workflows/release.yml`)

**Purpose**: Production releases triggered by semantic version tags.

**Triggers**:
- Push to `main` branch (for documentation updates)
- Push of tags matching `v*.*.*` pattern (e.g., v1.0.0, v1.2.3)

**Key Features**:
- **Semantic Version Validation**: Enforces `v{major}.{minor}.{patch}` format
- **Version-Aware Changelog**: Generates CHANGELOG.md comparing against previous release
- **Production Quality**: Creates official GitHub releases (not prereleases)
- **Long-term Retention**: 365-day artifact retention for production releases
- **Comprehensive Metadata**: Full release information with commit links

**Release Package Contents**:
- `swift-format-proxy` - Universal macOS binary
- `README.md` - Complete project documentation
- `LICENSE` - MIT License file
- `CHANGELOG.md` - Version-specific changelog with commit history
- `BUILDINFO.md` - Release metadata and Bill of Materials

**Critical Steps to Maintain**:
1. **Version Validation**: Strict semantic versioning enforcement
2. **Previous Tag Detection**: Automatically finds previous version for changelog
3. **Commit Range Analysis**: Shows changes since last release
4. **Release Notes**: Auto-generates GitHub release notes
5. **Production Quality**: Marked as stable release (not prerelease)

### Workflow Dependencies and Actions

**Required GitHub Actions**:
- `actions/checkout@v4` - Repository checkout
- `swift-actions/setup-swift@v2` - Swift toolchain setup
- `actions/cache@v4` - Build cache management
- `actions/upload-artifact@v4` - Artifact upload
- `actions/download-artifact@v4` - Artifact download
- `softprops/action-gh-release@v2` - GitHub release creation

**System Requirements**:
- `macos-latest` runner for Swift builds
- `ubuntu-latest` runner for release creation
- Xcode Command Line Tools (provided by macOS runner)
- `lipo` tool for universal binary creation

### Changelog Generation Strategy

**Build Workflow Changelog**:
- Shows last 10 commits with GitHub commit links
- Includes build metadata (number, date, commit, branch)
- Clearly marked as development build
- Links to official releases page

**Release Workflow Changelog**:
- Compares against previous semantic version tag
- Shows all commits between versions with GitHub links
- Includes complete release metadata
- Professional formatting for production use

**Changelog Format**:
```markdown
# Changelog

## [v1.0.0] - 2025-08-17

### Changes since v0.9.0
- feat: Add new feature ([abc123](https://github.com/ultralove/swift-format-proxy/commit/abc123))
- fix: Resolve critical bug ([def456](https://github.com/ultralove/swift-format-proxy/commit/def456))

### Release Information
- **Version:** v1.0.0
- **Release Date:** 2025-08-17
- **Commit:** [`abc123`](https://github.com/ultralove/swift-format-proxy/commit/abc123)
- **Tag:** [`v1.0.0`](https://github.com/ultralove/swift-format-proxy/releases/tag/v1.0.0)
```

### Recreating the Workflows

If the workflows need to be recreated, follow this exact structure:

1. **Create `.github/workflows/build.yml`** with:
   - Universal binary build process (x86_64 + arm64)
   - Changelog generation from git history
   - BUILDINFO.md creation with metadata
   - Archive creation with all files
   - Prerelease creation for development builds

2. **Create `.github/workflows/release.yml`** with:
   - Semantic version validation
   - Version-aware changelog generation
   - Production release creation
   - Long-term artifact retention

3. **Key Configuration Values**:
   - Swift version: `6.1`
   - Cache keys: Include Package.swift hash
   - Retention: 30/90/365 days based on type
   - Archive naming: Include version/build number and date

4. **Required Environment Variables**:
   - `GITHUB_TOKEN`: Provided automatically by GitHub Actions
   - `github.repository`: Used for commit links
   - `github.sha`: Current commit hash
   - `github.ref_name`: Branch or tag name

### Workflow Maintenance Guidelines

- **Version Updates**: When Swift version changes, update both workflows
- **Action Updates**: Regularly update action versions (checkout, cache, etc.)
- **Naming Conventions**: Maintain consistent naming for releases and artifacts
- **Documentation**: Keep BUILDINFO.md and CHANGELOG.md format consistent
- **Testing**: Test workflow changes on feature branches before merging
- **Security**: Never store secrets in workflow files - use GitHub Secrets

This workflow system provides professional-grade CI/CD with comprehensive documentation, version tracking, and user-friendly release packages suitable for production use.
